<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Facility Checklist App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; }
        .modal-body { font-size: 0.95rem; }
    </style>
</head>
<body>
<div class="container">
    <h2>Facility Checklist App</h2>
    <div id="auth-section">
        <div class="mb-3">
            <button class="btn btn-primary" onclick="showRegister()">Register</button>
            <button class="btn btn-success" onclick="showLogin()">Login</button>
        </div>
        <form id="register-form" style="display:none;">
            <h4>Register</h4>
            <input class="form-control mb-2" type="text" placeholder="Username" id="reg-username" required>
            <input class="form-control mb-2" type="password" placeholder="Password" id="reg-password" required>
            <button type="submit" class="btn btn-primary">Register</button>
            <button class="btn btn-link" onclick="hideForms()">Cancel</button>
        </form>
        <form id="login-form" style="display:none;">
            <h4>Login</h4>
            <input class="form-control mb-2" type="text" placeholder="Username" id="login-username" required>
            <input class="form-control mb-2" type="password" placeholder="Password" id="login-password" required>
            <button type="submit" class="btn btn-success">Login</button>
            <button class="btn btn-link" onclick="hideForms()">Cancel</button>
        </form>
    </div>
    <div id="main-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Checklists</h4>
            <div>
                <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
                <button class="btn btn-primary btn-sm" onclick="showChecklistForm()">+ Add Checklist</button>
            </div>
        </div>
        <div id="checklists"></div>
    </div>
</div>

<!-- Checklist Modal -->
<div class="modal fade" id="checklistModal" tabindex="-1" aria-labelledby="checklistModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form id="checklist-form" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="checklistModalLabel">Checklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Fields with info buttons for modals -->
                <div class="mb-2">
                    <label>
                        Function Location ID
                        <button class="btn btn-sm btn-link p-0" type="button" onclick="showFieldModal('Function Location ID', 'Enter the unique location ID for the facility.')">?</button>
                    </label>
                    <input type="text" class="form-control" id="cl-function-location-id" required>
                </div>
                <div class="mb-2">
                    <label>
                        Building Name
                        <button class="btn btn-sm btn-link p-0" type="button" onclick="showFieldModal('Building Name', 'Full name of the facility or building.')">?</button>
                    </label>
                    <input type="text" class="form-control" id="cl-building-name" required>
                </div>
                <div class="mb-2">
                    <label>
                        Inspector
                        <button class="btn btn-sm btn-link p-0" type="button" onclick="showFieldModal('Inspector', 'Name or ID of the inspector completing this checklist.')">?</button>
                    </label>
                    <input type="text" class="form-control" id="cl-inspector" required>
                </div>
                <div class="mb-2">
                    <label>
                        Inspection Date
                        <button class="btn btn-sm btn-link p-0" type="button" onclick="showFieldModal('Inspection Date', 'Date of the inspection.')">?</button>
                    </label>
                    <input type="date" class="form-control" id="cl-inspection-date" required>
                </div>
                <div class="mb-2">
                    <label>
                        Latitude
                        <button class="btn btn-sm btn-link p-0" type="button" onclick="showFieldModal('Latitude', 'GPS Latitude coordinate. Use your device GPS or Google Maps to collect.')">?</button>
                    </label>
                    <input type="number" step="any" class="form-control" id="cl-latitude">
                </div>
                <div class="mb-2">
                    <label>
                        Longitude
                        <button class="btn btn-sm btn-link p-0" type="button" onclick="showFieldModal('Longitude', 'GPS Longitude coordinate. Use your device GPS or Google Maps to collect.')">?</button>
                    </label>
                    <input type="number" step="any" class="form-control" id="cl-longitude">
                </div>
                <!-- Add more fields here as needed with similar info buttons -->
                <input type="hidden" id="cl-id">
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Field Info Modal -->
<div class="modal fade" id="fieldInfoModal" tabindex="-1" aria-labelledby="fieldInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fieldInfoModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="fieldInfoModalBody"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE_URL = https://facilityprofilingupdated.onrender.com; // <-- CHANGE THIS!

let authToken = null;
let editingId = null;

function showRegister() {
    hideForms();
    document.getElementById('register-form').style.display = '';
}
function showLogin() {
    hideForms();
    document.getElementById('login-form').style.display = '';
}
function hideForms() {
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('login-form').style.display = 'none';
}
function logout() {
    authToken = null;
    document.getElementById('auth-section').style.display = '';
    document.getElementById('main-section').style.display = 'none';
}
document.getElementById('register-form').onsubmit = async (e) => {
    e.preventDefault();
    const username = document.getElementById('reg-username').value;
    const password = document.getElementById('reg-password').value;
    const res = await fetch(API_BASE_URL + '/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ username, password })
    });
    if (res.ok) {
        alert('Registration successful! Please login.');
        showLogin();
    } else {
        alert('Registration failed!');
    }
};
document.getElementById('login-form').onsubmit = async (e) => {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    const res = await fetch(API_BASE_URL + '/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ username, password })
    });
    const data = await res.json();
    if (res.ok && data.access_token) {
        authToken = data.access_token;
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('main-section').style.display = '';
        loadChecklists();
    } else {
        alert('Login failed!');
    }
};

function showChecklistForm(checklist=null) {
    editingId = checklist ? checklist.id : null;
    document.getElementById('cl-id').value = checklist ? checklist.id : '';
    document.getElementById('cl-function-location-id').value = checklist ? checklist.function_location_id : '';
    document.getElementById('cl-building-name').value = checklist ? checklist.building_name : '';
    document.getElementById('cl-inspector').value = checklist ? checklist.inspector : '';
    document.getElementById('cl-inspection-date').value = checklist ? checklist.inspection_date : '';
    document.getElementById('cl-latitude').value = checklist ? checklist.latitude : '';
    document.getElementById('cl-longitude').value = checklist ? checklist.longitude : '';
    // Add more fields here if needed
    new bootstrap.Modal(document.getElementById('checklistModal')).show();
}

document.getElementById('checklist-form').onsubmit = async (e) => {
    e.preventDefault();
    const payload = {
        function_location_id: document.getElementById('cl-function-location-id').value,
        building_name: document.getElementById('cl-building-name').value,
        inspector: document.getElementById('cl-inspector').value,
        inspection_date: document.getElementById('cl-inspection-date').value,
        latitude: parseFloat(document.getElementById('cl-latitude').value),
        longitude: parseFloat(document.getElementById('cl-longitude').value)
        // Add more fields as needed
    };
    let res, data;
    if (editingId) {
        res = await fetch(`${API_BASE_URL}/inspections/${editingId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
            body: JSON.stringify(payload)
        });
    } else {
        res = await fetch(`${API_BASE_URL}/inspections`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
            body: JSON.stringify(payload)
        });
    }
    data = await res.json();
    if (res.ok) {
        bootstrap.Modal.getInstance(document.getElementById('checklistModal')).hide();
        loadChecklists();
    } else {
        alert('Error: ' + (data.detail || 'Operation failed'));
    }
};

async function loadChecklists() {
    const res = await fetch(`${API_BASE_URL}/inspections`, {
        headers: { 'Authorization': 'Bearer ' + authToken }
    });
    const data = await res.json();
    const el = document.getElementById('checklists');
    el.innerHTML = '<table class="table table-bordered"><thead><tr>' +
        '<th>ID</th><th>Function Location ID</th><th>Building Name</th><th>Inspector</th><th>Date</th><th>Lat</th><th>Long</th><th>Actions</th>' +
        '</tr></thead><tbody>' +
        (data.inspections || []).map(r =>
            `<tr>
                <td>${r.id}</td>
                <td>${r.function_location_id}</td>
                <td>${r.building_name}</td>
                <td>${r.inspector}</td>
                <td>${r.inspection_date}</td>
                <td>${r.latitude}</td>
                <td>${r.longitude}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick='editChecklist(${JSON.stringify(r)})'>Edit</button>
                    <button class="btn btn-sm btn-danger" onclick='deleteChecklist(${r.id})'>Delete</button>
                </td>
            </tr>`
        ).join('') +
        '</tbody></table>';
}
window.editChecklist = (row) => showChecklistForm(row);

window.deleteChecklist = async (id) => {
    if (!confirm("Are you sure you want to delete this checklist?")) return;
    const res = await fetch(`${API_BASE_URL}/inspections/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + authToken }
    });
    if (res.ok) loadChecklists();
    else alert('Delete failed');
}

window.showFieldModal = (title, body) => {
    document.getElementById('fieldInfoModalLabel').innerText = title;
    document.getElementById('fieldInfoModalBody').innerText = body;
    new bootstrap.Modal(document.getElementById('fieldInfoModal')).show();
};

</script>
</body>
</html>
